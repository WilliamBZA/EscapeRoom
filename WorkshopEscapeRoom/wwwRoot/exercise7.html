<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Escape room fun!</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Exercises</a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="exercise1.html">Exercise 1 - Intro to NanoFramework</a></li>
                                    <li><a class="dropdown-item" href="exercise2.html">Exercise 2 - Turning devices on/off</a></li>
                                    <li><a class="dropdown-item" href="exercise3.html">Exercise 3 - Responding to HTTP requests</a></li>
                                    <li><a class="dropdown-item" href="exercise4.html">Exercise 4 - Intro to Azure Service Bus</a></li>
                                    <li><a class="dropdown-item" href="exercise5.html">Exercise 5 - Pub/Sub</a></li>
                                    <li><a class="dropdown-item" href="exercise6.html">Exercise 6 - Dealing with failures</a></li>
                                    <li><a class="dropdown-item active" href="exercise7.html">Exercise 7 - Building an efficient pipeline</a></li>
                                    <li><a class="dropdown-item" href="exercise8.html">Exercise 8 - Message Timeouts</a></li>
                                    <li><a class="dropdown-item" href="exercise9.html">Exercise 9 - Rate Limiting</a></li>
                                    <li><a class="dropdown-item" href="exercise10.html">Exercise 10 - Delayed Delivery</a></li>
                                    <li><a class="dropdown-item" href="exercise11.html">Exercise 11 - Further patterns to learn</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/">Code Repo</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/exercises/solutions">Solutions</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <div class="container heading">
            <div>
                <h1>Exercise 7:</h1>
                <h4>Building a more efficient pipeline</h4>
            </div>
        </div>
        
        <div class="container exercisedetails">
            <div class="col-lg-12">
                <ul class="nav nav-tabs" id="exercise-headings" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="gpio-tab" type="button" data-bs-toggle="tab" data-bs-target="#gpio-tab-content" role="tab" aria-controls="visualstudio-tab-content" aria-selected="false">
                            Message processing pipelines
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bonusexercise-tab" type="button" data-bs-toggle="tab" data-bs-target="#bonus-exercise-tab-content" role="tab" aria-controls="bonus-exercise-tab-content" aria-selected="true">
                            Bonus exercises
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="exerciseContent">
                    <div class="tab-pane show active" id="gpio-tab-content" role="tabpanel" aria-labelledby="gpio-tab" tabindex="0">
                        <div>
                            Before we dive deeper into more error handling, let's take a step back and talk performance. A resilient system is great, but a slow
                            resilient system? Not so much. In this exercise, we'll explore how to make your message processing pipeline more efficient
                            using tools like concurrency, batching, and prefetching.
                        </div>
                        <div>
                            We're going to look at three levers that can help you crank up your throughput without compromising reliability:
                            <ul>
                                <li><strong>Concurrency</strong> - process more than one message at a time.</li>
                                <li><strong>Batching</strong> - handle several messages together to reduce overhead.</li>
                                <li><strong>Prefetching</strong> - fetch messages ahead of time so they're ready when you are.</li>
                            </ul>
                        </div>

                        <h3 class="breadcrumb" id="vs-step1">1. Increase Message Concurrency</h3>
                        <div>
                            The Azure SDK has a default concurrency of 1 when receiving messages. This means that by default, your message processor handles <strong>one</strong>
                            message at a time. That's safe, but slow. Azure Service Bus supports parallel message handling using the <code>MaxConcurrentCalls</code> property.
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">serviceBusOptions</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusProcessorOptions</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;MaxConcurrentCalls&nbsp;=&nbsp;10
};
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">processor</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateProcessor</span>(<span style="color:#a31515;">&quot;thedrivein&quot;</span>,&nbsp;<span style="color:#1f377f;">serviceBusOptions</span>);
</pre>
                        </div>
                        <div>
                            Making this change means that instead of processing a single message at a time, your application will process up to 10 at a time.
                            This takes advantage of multiple CPU cores and can reduce how long it takes to work through all the messages in a queue.
                        </div>
                        <div>
                            Just remember you're now putting more pressure on whatever systems your handler depends on (like databases, APIs, etc.). So it's important
                            to test and observe how your system reacts to this increased concurrency.
                        </div>
                        <div>
                            A good default to start with is to set the <code>MaxConcurrentCalls</code> to match the number of cores available. From here, keep an eye on the
                            system performance. Is the CPU managing to cope? Is the queue length staying under control? If things look stable, you can try and bump the
                            concurrency up.
                        </div>
                        <div>
                            Your task now is to change the concurrency of your console applications. Before starting your application, send 100 messages to the topic.
                        </div>
                        <div>
                            Now start your application with the new concurrency and monitor how quickly the messages are processed in parallel.
                        </div>
                        <div>
                            Try again with different concurrencies. Try 5, 20, and 100. See what impact each of these have on your throughput.
                        </div>

                        <div class="note">
                            <strong>🧪 Tip:</strong> Try timing how long it takes to process all 100 messages before and after each change. Just a simple stopwatch or <code>DateTime.UtcNow</code> can help.
                            Even better if you track CPU usage and memory too!
                        </div>

                        <h3 class="breadcrumb" id="vs-step2">2. Prefetching</h3>
                        <div>
                            Every time your app fetches a message from Azure Service Bus, it makes a network call. That doesn't take long, but if you're
                            processing a lot of messages, it adds up fast. Prefetching helps by grabbing a bunch of messages up front and keeping them ready in memory.
                        </div>
                        <div>
                            This means less waiting between messages, and your processor stays busier which usually means better throughput. To use it, you just need
                            to add a <code>PrefetchCount</code> to the <code>ServiceBusProcessorOptions</code> class you pass when creating your
                            <code>ServiceBusProcessor</code>. A value like 20 is a good place to start if you're processing 10 messages concurrently.
                        </div>
                        <div>
                            Just like with concurrency, there's a trade-off. Prefetched messages are locked and held in memory, even if you're not ready to
                            process them yet. If your system is memory-constrained or your message processing is slow, you'll want to tune this carefully.
                        </div>
                        <div>
                            <strong>Choosing a good value:</strong> Try setting it to 2-4 times your concurrency. So if you're using <code>MaxConcurrentCalls = 10</code>,
                            go for a prefetch count of 20 to 40. Then, experiment. If memory usage looks good and processing is snappy, you're in a good spot. If
                            things slow down or you're seeing lock timeouts, it might be too hig
                        </div>

                        <h3 class="breadcrumb" id="vs-step3">3. Batching</h3>
                        <div>
                            Batching messages isn't a huge factor when using the ServiceBusProcessor, since it handles one message at a time internally.
                            But it's still worth understanding especially if you're ever sending messages or using the lower-level <code>ServiceBusReceiver</code>.
                        </div>
                        <div>
                            Instead of sending messages one by one, you can bundle several into a single request. That cuts down on round-trips and network
                            overhead, which can make a big difference at scale.
                        </div>
                        <div>
                            For example, using the <code>ServiceBusSender</code>, you can create a batch and add multiple messages to it before sending
                            them off in one go. This is especially useful when you're generating a lot of messages quickly.
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">batch</span>&nbsp;=&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender</span>.<span style="color:#74531f;">CreateMessageBatchAsync</span>();
<span style="color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">i</span>&nbsp;=&nbsp;0;&nbsp;<span style="color:#1f377f;">i</span>&nbsp;&lt;&nbsp;500;&nbsp;<span style="color:#1f377f;">i</span>++)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#1f377f;">batch</span>.<span style="color:#74531f;">TryAddMessage</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#a31515;">$&quot;</span><span style="color:#a31515;">Message&nbsp;</span>{<span style="color:#1f377f;">i</span>}<span style="color:#a31515;">&quot;</span>));
}
<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender</span>.<span style="color:#74531f;">SendMessagesAsync</span>(<span style="color:#1f377f;">batch</span>);
</pre>
                        </div>
                        <div>
                            This creates a batch of 500 messages and sends them as a single unit.
                        </div>
                        <div>
                            Try change your console application that generates 100 messages to use batches. Is there a noticable difference in how long
                            it takes to send 100 messages?
                        </div>
                    </div>

                    <div class="tab-pane" id="bonus-exercise-tab-content" rold="tabpanel" aria-labelledby="bonusexercise-tab" tabindex="2">
                        <h3>Bonus round!</h3>

                        <div>
                            Done already? Waiting for everyone else to finish? Why not tackle some of these bonus challenges?
                        </div>

                        <h3 class="breadcrumb">1. Measure throughput</h3>
                        <div>
                            Record how long it takes to process 100 messages with different <code>MaxConcurrentCalls</code> values (e.g. 1, 10, 50, 100).
                            Is there a point where increasing concurrency stops helping?
                        </div>
                        <div>
                            What patterns do you notice? At what point do you hit diminishing returns? Try to identify your system's sweet spot.
                        </div>

                        <h3 class="breadcrumb">2. Change your handler to do something thread intensive</h3>
                        <div>
                            How does this impact the optimal concurrency setting?
                        </div>
                        <div>
                            What if the handlers were doing something IO intensive?
                        </div>

                        <h3 class="breadcrumb">3. Combine prefetching + concurrency</h3>
                        <div>
                            Set <code>MaxConcurrentCalls = 10</code> and <code>PrefetchCount = 40</code>. Then try with <code>PrefetchCount = 100</code>.
                        </div>
                        <div>
                            What happens to memory usage and throughput? Try pushing it too far—how does your app behave under pressure?
                        </div>

                        <h3 class="breadcrumb">4. Push batching too far</h3>
                        <div>
                            Azure Service Bus batches aren't just limited by the number of messages: they're limited by <strong>total size</strong>. Even if you're only sending 100 messages,
                            you might not be able to fit them all in one batch if the messages are large.
                        </div>
                        <div>
                            Your task: experiment with batching to see where the limits are.
                        </div>
                        
                        <ol>
                            <li>Start with small messages, like <code>"Message 1"</code> to <code>"Message 100"</code>. Try batching all 100 into one send. Does it work?</li>
                            <li>Now make the messages larger. Try messages that are 10 KB, 100 KB, or even bigger. At what point does <code>TryAddMessage()</code> return <code>false</code>?</li>
                            <li>Print the index where the message no longer fits. What does that tell you about the real-world limit?</li>
                        </ol>
                        
                        <div>
                            Use this snippet as a starting point:
                        </div>
                        
                        <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">batch</span>&nbsp;=&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender</span>.<span style="color:#74531f;">CreateMessageBatchAsync</span>();
<span style="color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">i</span>&nbsp;=&nbsp;0;&nbsp;<span style="color:#1f377f;">i</span>&nbsp;&lt;&nbsp;100;&nbsp;<span style="color:#1f377f;">i</span>++)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">bigMessage</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:blue;">string</span>(<span style="color:#a31515;">&#39;*&#39;</span>,&nbsp;<span style="color:#1f377f;">i</span>&nbsp;*&nbsp;100);&nbsp;<span style="color:#066555;">//&nbsp;increase&nbsp;size&nbsp;gradually</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">success</span>&nbsp;=&nbsp;<span style="color:#1f377f;">batch</span>.<span style="color:#74531f;">TryAddMessage</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#1f377f;">bigMessage</span>));

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">if</span>&nbsp;(!<span style="color:#1f377f;">success</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">$&quot;</span><span style="color:#a31515;">Batch&nbsp;full&nbsp;at&nbsp;message&nbsp;</span>{<span style="color:#1f377f;">i</span>}<span style="color:#a31515;">&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">break</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
}
<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender</span>.<span style="color:#74531f;">SendMessagesAsync</span>(<span style="color:#1f377f;">batch</span>);
</pre>
                        
                        <div>
                            What's the maximum batch size in terms of:
                            <ul>
                                <li>Number of messages?</li>
                                <li>Total data size (in KB or MB)?</li>
                            </ul>
                        </div>
                        
                        <div>
                            Azure Service Bus has a size limit per batch (including headers), so this is a great chance to see that in action. The size limit is <strong>256KB</strong> for Standard tier, and <strong>1MB</strong>
                            for Premium tier.
                        </div>
                    </div>
                    <div class="footer-nav">
                        <a href="exercise6.html">&lt; Go to Exercise 6</a><a href="exercise8.html">Go to Exercise 8 &gt;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>