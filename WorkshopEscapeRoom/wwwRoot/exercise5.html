<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Escape room fun!</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Exercises</a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="exercise1.html">Exercise 1 - Intro to NanoFramework</a></li>
                                    <li><a class="dropdown-item" href="exercise2.html">Exercise 2 - Turning devices on/off</a></li>
                                    <li><a class="dropdown-item" href="exercise3.html">Exercise 3 - Responding to HTTP requests</a></li>
                                    <li><a class="dropdown-item" href="exercise4.html">Exercise 4 - Intro to Azure Service Bus</a></li>
                                    <li><a class="dropdown-item active" href="exercise5.html">Exercise 5 - Pub/Sub</a></li>
                                    <li><a class="dropdown-item" href="exercise6.html">Exercise 6 - Dealing with failures</a></li>
                                    <li><a class="dropdown-item" href="exercise7.html">Exercise 7 - Building an efficient pipeline</a></li>
                                    <li><a class="dropdown-item" href="exercise8.html">Exercise 8 - Message Timeouts</a></li>
                                    <li><a class="dropdown-item" href="exercise9.html">Exercise 9 - Rate Limiting</a></li>
                                    <li><a class="dropdown-item" href="exercise10.html">Exercise 10 - Delayed Delivery</a></li>
                                    <li><a class="dropdown-item" href="exercise11.html">Exercise 11 - Further patterns to learn</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/">Code Repo</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/exercises/solutions">Solutions</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <div class="container heading">
            <div>
                <h1>Exercise 5:</h1>
                <h4>Routing messages</h4>
            </div>
        </div>
        
        <div class="container exercisedetails">
            <div class="col-lg-12">
                <ul class="nav nav-tabs" id="exercise-headings" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="gpio-tab" type="button" data-bs-toggle="tab" data-bs-target="#gpio-tab-content" role="tab" aria-controls="visualstudio-tab-content" aria-selected="false">
                            Pub/Sub
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bonusexercise-tab" type="button" data-bs-toggle="tab" data-bs-target="#bonus-exercise-tab-content" role="tab" aria-controls="bonus-exercise-tab-content" aria-selected="true">
                            Bonus exercises
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="exerciseContent">
                    <div class="tab-pane show active" id="gpio-tab-content" role="tabpanel" aria-labelledby="gpio-tab" tabindex="0">
                        <div>
                            What we looked at in the previous exercise was how to Send Commands. Commands have specific intent. They are an instruction to do something
                            specific. Examples of commands are:
                        </div>
                        <div>
                            <ul>
                                <li>ChargeCreditCard</li>
                                <li>DeactivateAccount</li>
                                <li>UnlockDoor</li>
                            </ul>
                        </div>

                        <div>
                            A trait that Commands have is that they are processed by a single, logical processor. A <code>ChargeCreditCard</code> command always goes
                            to the <i>same</i> logical processor. In terms of our previous exercise, the <code>ChargeCreditCard</code> Command always goes to the same Queue.
                        </div>

                        <div>
                            The converse to Commands are <strong>Events</strong>.
                        </div>

                        <div>
                            Events are a statement of fact. Something has happened. A customer's credit card has been successfully charged. These events <i>come</i> from a single,
                            logical processor but can go to multiple locations. Anybody that is interested in an event occurring can subscribe to the event.
                        </div>

                        <div>
                            In terms of our last example: An Event is sent by a single processor, but it can go to multiple other queues.
                        </div>

                        <div>
                            This exercise is about how to set up publishers using Azure Service Bus.
                        </div>

                        <h3 class="breadcrumb" id="vs-step1">1. Create a second Console Application</h3>
                        <div>
                            Since we previously sent a message to a single queue, we now want to introduce a second application that will also receive the same message. To do this, follow these steps:
                        </div>

                        <div>
                            <ol>
                                <li>In the Azure Portal, navigate to the Service Bus Resource and click on the <code>+ Queue</code> link at the top of the page.</li>
                                <li>Come up with a name for your console application's queue (maybe a variation of your device queue that you created in exercise 4? I called mine <code>ThedriveinVirtualDevice</code>)</li>
                                <li>Create a new Console Application (e.g., <code>MessageReceiver2</code>).</li>
                                <li>Install the Azure.Messaging.ServiceBus NuGet package</li>
                                <li>Update Program.cs to receive messages from the queue you just created. Copy the message receiver logic from your first Console Application, but update it to connect to the second queue instead.</li>
                            </ol>
                        </div>

                        <div>
                            At this point, both Console Applications can receive messages, but they are still independent. In the next steps, we will modify this so they
                            both receive the messages when the LEDs are toggled.
                        </div>

                        <h3 class="breadcrumb" id="vs-step2">2. Send the Message to both queues</h3>
                        <div>
                            Now, update your message sender so it sends the same message to both queues. Modify your Sender's (the console application) <code>Program.cs</code> file:
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">static</span>&nbsp;<span style="color:blue;">async</span>&nbsp;<span style="color:#066555;">Task</span>&nbsp;<span style="color:#74531f;">Main</span>(<span style="color:blue;">string</span>[]&nbsp;<span style="color:#1f377f;">args</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">await</span>&nbsp;<span style="color:blue;">using</span>&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">client</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusClient</span>(<span style="color:#a31515;">&quot;ConnectionStringGoesHere&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Create&nbsp;sender&nbsp;for&nbsp;the&nbsp;first&nbsp;queue,&nbsp;i.e.&nbsp;the&nbsp;device&nbsp;queue</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">senderToNanoFramework</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateSender</span>(<span style="color:#a31515;">&quot;thedrivein&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Create&nbsp;sender&nbsp;for&nbsp;second&nbsp;queue,&nbsp;i.e.&nbsp;the&nbsp;second&nbsp;console&nbsp;application&nbsp;you&nbsp;just&nbsp;created</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">senderToConsoleApp</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateSender</span>(<span style="color:#a31515;">&quot;thedriveinvirtualdevice&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Create&nbsp;a&nbsp;message</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">toggleMessage</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ToggleLEDs</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ToggleSource&nbsp;=&nbsp;<span style="color:#a31515;">&quot;Console&nbsp;Application&quot;</span>
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;<span style="color:#1f377f;">jsonMessage</span>&nbsp;=&nbsp;<span style="color:#066555;">JsonSerializer</span>.<span style="color:#74531f;">Serialize</span>(<span style="color:#1f377f;">toggleMessage</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">message</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#1f377f;">jsonMessage</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType&nbsp;=&nbsp;<span style="color:#a31515;">&quot;application/json&quot;</span>
&nbsp;&nbsp;&nbsp;&nbsp;};

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Sending&nbsp;message&nbsp;to&nbsp;both&nbsp;queues...&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Send&nbsp;message&nbsp;to&nbsp;both&nbsp;queues&nbsp;separately</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">senderToNanoFramework</span>.<span style="color:#74531f;">SendMessageAsync</span>(<span style="color:#1f377f;">message</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">senderToConsoleApp</span>.<span style="color:#74531f;">SendMessageAsync</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#1f377f;">message</span>.Body));

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Message&nbsp;sent&nbsp;to&nbsp;both&nbsp;queues!&quot;</span>);
}
</pre>
                        </div>

                        <div>
                            This is great. We're now able to send the same message to 2 queues - one for our NanoFramework application and one for the second
                            Console Application. While this works, it's not ideal for real-world scenarios where multiple receivers need consistency.
                            And this feels weird, right? <i>Right...?</i>
                        </div>

                        <div>
                            That's because things go wrong. Exceptions get thrown. Networks fail. Timeouts occur. Lots of things can go wrong when you're doing network
                            operations. What do I mean by this?
                        </div>

                        <div>
                            Let's look at an example:
                        </div>

                        <div>
                            Instead of a NanoFramework application and a console application, let's assume we're trying to toggle the LEDs of 2 separate NanoFramework
                            applications. They must show the same toggle state.
                        </div>

                        <div>
                            If our sender is able to successfully send both <code>ToggleLEDs</code> messages, then the NanoFramework applications should remain in sync
                            just fine. But what if our sender sends the first <code>ToggleLEDs</code> message, and then disconnects from the network? Or crashes due to
                            a memory leak?
                        </div>

                        <div>
                            If this happened, then the NanoFramework applications would no longer in the same state. In distributed systems speak, We call
                            this an Inconsistent State.
                        </div>

                        <div>
                            Inconsistent state is problematic for a few reasons. In most business systems, the "state" of the system is typically represented by
                            some form of data stored in a database of some kind. A message queue is another form of database, except that it onlhy stores commands
                            and events (or intents and facts). Since we've introduced another database, it becomes a problem if one database is no longer in sync
                            with another.
                        </div>

                        <div>
                            For example, let's assume that we send a message to charge a customer's credit card. If the message handler successfully charges the
                            customer's credit card, but on the next line of code it throws an exception. In this case, the message will remain in the queue to
                            be processed by another thread. Except that the customer's credit card has been charged! So if the next thread picks up the message
                            and processes it, it will double-charge the customer's credit card! 😡
                        </div>

                        <div>
                            We'll look at this is more detail in a later section of the workshop.
                        </div>

                        <div>
                            Imagine if we tried the same approach with accounting software: We send 2 messages - a Debit and a Credit. If only the Debit is successfully
                            sent, then the balance sheet would never balance - the Credit is lost!
                        </div>

                        <div>
                            We would like our Send operations to be <strong>Atomic</strong>. We want to publish once, and know that everyone that is interested in the
                            message that we published will receive a copy of it.
                        </div>

                        <div>
                            We can achieve this in Azure ServiceBus by using Topis and Subscriptions.
                        </div>

                        <h3 class="breadcrumb" id="vs-step3">3. Use a Transaction to send to multiple queues atomically</h3>
                        <div>
                            In Step 2, you saw that sending to multiple queues separately can lead to inconsistent state if one send fails.
                        </div>
                        <div>
                            To solve this, Azure Service Bus supports <strong>transactions</strong> that allow you to group multiple operations into a single atomic unit. That way, either all messages are sent or none are.
                        </div>
                        <div>
                            Modify your sender to use a transaction: In your sender app, replace the separate <code>SendMessageAsync</code> calls with code that uses a <code>ServiceBusTransaction</code>.
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">sender1</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateSender</span>(<span style="color:#a31515;">&quot;thedrivein&quot;</span>);
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">sender2</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateSender</span>(<span style="color:#a31515;">&quot;thedriveinconsoledevice&quot;</span>);
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">receiver</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateReceiver</span>(<span style="color:#a31515;">&quot;incomingqueue&quot;</span>);
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">receivedMessage</span>&nbsp;=&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">receiver</span>.<span style="color:#74531f;">ReceiveMessageAsync</span>();

<span style="color:blue;">using</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">transaction</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">TransactionScope</span>(<span style="color:#066555;">TransactionScopeAsyncFlowOption</span>.Enabled))
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">receiver</span>.<span style="color:#74531f;">CompleteMessageAsync</span>(<span style="color:#1f377f;">receivedMessage</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender1</span>.<span style="color:#74531f;">SendMessageAsync</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>());
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">sender2</span>.<span style="color:#74531f;">SendMessageAsync</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>());

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#1f377f;">transaction</span>.<span style="color:#74531f;">Complete</span>();
}
</pre>
                        </div>
                        <div>
                            You can now test the transactionality by simulating a failure (e.g. by throwing an exception before the call to <code>transaction.Complete();</code>) and verifying that no messages are sent if the transaction fails.
                        </div>

                        <h3 class="breadcrumb" id="vs-step4">4. Add a Topic to Azure Service Bus</h3>
                        <div>
                            Instead of a queue, we will now use a Topic. Topics allow multiple subscribers to receive the same message, enabling a publish-subscribe pattern.
                            To create a topic, follow these steps:
                        </div>
                        <div>
                            <ol>
                                <li>Open the Azure Portal and find the Service Bus Resource we've been using</li>
                                <li>Navigate to the Topics section and click + Topic at the top of the page</li>
                                <li>Choose a name for your topic (e.g., <code>TeamNameLedToggleTopic</code>) and click Create.</li>
                            </ol>
                        </div>
                        <div>
                            You now have a topic ready to use, and 2 queues ready to receive messages from that topic! We now need to bind those queues to that topic using subscriptions.
                        </div>
                        <div>
                            So let's bind the queues to that topic...
                        </div>

                        <h3 class="breadcrumb" id="vs-step5">5. Bind both queues to the Topic</h3>
                        <div>
                            Now that we've created a <strong>Topic</strong>, we want both of our queues to receive messages from it. Instead of sending messages directly to the queues,
                            we will bind them as <strong>subscriptions</strong> to the topic. This way, any message sent to the <strong>Topic</strong> will be automatically forwarded to both queues.
                        </div>
                        <div>
                            To bind the queues to the subscription, do the following steps:
                        </div>
                        <div>
                            <ol>
                                <li>Navigate to the Azure Portal page for the topic that you just created in step 3</li>
                                <li>Click <code>+Subscription</code> button at the top of the screen</li>
                                <li>
                                    Create the first subscription:
                                    <ol>
                                        <li><strong>Subscription Name:</strong> <code>Thedriveintoggleledssubscription</code></li>
                                        <li>Check the <code>Forward messages to queue/topic</code> checkbox</li>
                                        <li><strong>Forward To:</strong> Select the queue you created for your NanoFramework device. (In my case, it's <code>thedrivein</code>)</li>
                                        <li>Click <strong>Create</strong></li>
                                    </ol>
                                </li>
                                <li>
                                    Create the second subscription:
                                    <ol>
                                        <li><strong>Subscription Name:</strong> <code>Thedriveinconsoleapptoggleledssubscription</code></li>
                                        <li>Check the <code>Forward messages to queue/topic</code> checkbox</li>
                                        <li><strong>Forward To:</strong> Select the queue you created for your NanoFramework device.</li>
                                        <li>Click <strong>Create</strong></li>
                                    </ol>
                                </li>
                                <li>Verify that both queues are now listed under Subscriptions for the topic.</li>
                            </ol>
                        </div>

                        <h3 class="breadcrumb" id="vs-step6">6. Send the message to the Topic only</h3>
                        <div>
                            Now that we've set up <strong>queue bindings</strong>, our sender should <strong>only send messages to the Topic</strong>, and the queues will receive them automatically.
                        </div>

                        <div>
                            Change your sender code to look like this:
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">static</span>&nbsp;<span style="color:blue;">async</span>&nbsp;<span style="color:#066555;">Task</span>&nbsp;<span style="color:#74531f;">Main</span>(<span style="color:blue;">string</span>[]&nbsp;<span style="color:#1f377f;">args</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">await</span>&nbsp;<span style="color:blue;">using</span>&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">client</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusClient</span>(<span style="color:#a31515;">&quot;ConnectionStringGoesHere&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Create&nbsp;sender&nbsp;for&nbsp;the&nbsp;topic</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Use&nbsp;your&nbsp;team&#39;s&nbsp;topic&nbsp;as&nbsp;the&nbsp;name</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">topicSender</span>&nbsp;=&nbsp;<span style="color:#1f377f;">client</span>.<span style="color:#74531f;">CreateSender</span>(<span style="color:#a31515;">&quot;thedriveinteamnameledtoggletopic&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Create&nbsp;a&nbsp;message</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">toggleMessage</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ToggleLEDs</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ToggleSource&nbsp;=&nbsp;<span style="color:#a31515;">&quot;Console&nbsp;Application&quot;</span>
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;<span style="color:#1f377f;">jsonMessage</span>&nbsp;=&nbsp;<span style="color:#066555;">JsonSerializer</span>.<span style="color:#74531f;">Serialize</span>(<span style="color:#1f377f;">toggleMessage</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">message</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#1f377f;">jsonMessage</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentType&nbsp;=&nbsp;<span style="color:#a31515;">&quot;application/json&quot;</span>
&nbsp;&nbsp;&nbsp;&nbsp;};

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Sending&nbsp;message&nbsp;to&nbsp;topic...&quot;</span>);

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Send&nbsp;message&nbsp;to&nbsp;the&nbsp;topic</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">topicSender</span>.<span style="color:#74531f;">SendMessageAsync</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">ServiceBusMessage</span>(<span style="color:#1f377f;">message</span>.Body));

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Message&nbsp;sent&nbsp;to&nbsp;the&nbsp;topic!&quot;</span>);
}
</pre>
                        </div>

                        <div>
                            👏 Well done! You've set up subscriptions so that a single send results in both queues receiving the same message. This has a few powerful benefits:
                        </div>
                        <div>
                            <ul>
                                <li>
                                    <strong>Atomicity</strong>. A single <strong>Send</strong> will result in both queues receiving the same message. There is no chance that
                                    one queue will receive the message and not the other. This makes it so that our send operations won't ever be the source of an inconsistent state.
                                </li>
                                <li>
                                    <strong>Maintainability</strong>. We can add future subscribers without making any code changes. With a Topic, you can simply add a new subscription in Azure without modifying the sender.
                                </li>
                                <li>
                                    <strong>Decoupling</strong>. The sender doesn't know anything about who is going to receive the message. There can be no coupling from the sender to the recipients.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="tab-pane" id="bonus-exercise-tab-content" rold="tabpanel" aria-labelledby="bonusexercise-tab" tabindex="2">
                        <h3>Bonus round!</h3>

                        <div>
                            Done already? Waiting for everyone else to finish? Why not tackle some of these bonus challenges?
                        </div>

                        <h3 class="breadcrumb">1. What happens if only the NanoFramework application is running?</h3>
                        <div>
                            Stop the console application receiver and send messages from the sender.
                        </div>
                        <div>
                            <ul>
                                <li>Are the messages that should go to the console application receiver lost?</li>
                                <li>Do the messages remain in the topic somewhere?</li>
                            </ul>
                        </div>

                        <h3 class="breadcrumb">2. What happens when one of the applications throws an exception?</h3>
                        <div>
                            Modify one of the subscriber applications to throw an exception when processing a message.
                        </div>
                        <div>
                            What happens to that message?
                        </div>

                        <h3 class="breadcrumb">3. What is the impact of Competing Consumers?</h3>
                        <div>
                            Run multiple instances of the Console Application listener and observe the impact. Do both instances get a copy of the messages? What if one of the instances throws an exception?
                        </div>
                    </div>
                    <div class="footer-nav">
                        <a href="exercise4.html">&lt; Go to Exercise 4</a><a href="exercise6.html">Go to Exercise 6 &gt;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>