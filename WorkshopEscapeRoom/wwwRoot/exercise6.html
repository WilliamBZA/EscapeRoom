<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Escape room fun!</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Exercises</a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="exercise1.html">Exercise 1 - Intro to NanoFramework</a></li>
                                    <li><a class="dropdown-item" href="exercise2.html">Exercise 2 - Turning devices on/off</a></li>
                                    <li><a class="dropdown-item" href="exercise3.html">Exercise 3 - Responding to HTTP requests</a></li>
                                    <li><a class="dropdown-item" href="exercise4.html">Exercise 4 - Intro to Azure Service Bus</a></li>
                                    <li><a class="dropdown-item" href="exercise5.html">Exercise 5 - Pub/Sub</a></li>
                                    <li><a class="dropdown-item active" href="exercise6.html">Exercise 6 - Dealing with failures</a></li>
                                    <li><a class="dropdown-item" href="exercise7.html">Exercise 7 - Building an efficient pipeline</a></li>
                                    <li><a class="dropdown-item" href="exercise8.html">Exercise 8 - Message Timeouts</a></li>
                                    <li><a class="dropdown-item" href="exercise9.html">Exercise 9 - Rate Limiting</a></li>
                                    <li><a class="dropdown-item" href="exercise10.html">Exercise 10 - Delayed Delivery</a></li>
                                    <li><a class="dropdown-item" href="exercise11.html">Exercise 11 - Further patterns to learn</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/">Code Repo</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/exercises/solutions">Solutions</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        
        <div class="container heading">
            <div>
                <h1>Exercise 6:</h1>
                <h4>Dealing with failures</h4>
            </div>
        </div>
        
        <div class="container exercisedetails">
            <div class="col-lg-12">
                <ul class="nav nav-tabs" id="exercise-headings" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="gpio-tab" type="button" data-bs-toggle="tab" data-bs-target="#gpio-tab-content" role="tab" aria-controls="visualstudio-tab-content" aria-selected="false">
                            ACK/NACK
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bonusexercise-tab" type="button" data-bs-toggle="tab" data-bs-target="#bonus-exercise-tab-content" role="tab" aria-controls="bonus-exercise-tab-content" aria-selected="true">
                            Bonus exercises
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="exerciseContent">
                    <div class="tab-pane show active" id="gpio-tab-content" role="tabpanel" aria-labelledby="gpio-tab" tabindex="0">
                        <div>
                            By now, you've got a solid Azure Service Bus application sending and receiving messages. But what happens when things
                            don't go as planned? Welcome to the world of distributed system failures - where things get interesting.
                        </div>
                        <div>
                            In this exercise, we'll explore different types of failures and how to handle them. Some failures are temporary - things like
                            network hiccups that go away on their own. Others need a bit more strategy, like backing off and trying again later. And then there
                            are the stubborn failures, where messages just refuse to be processed and need to be sent to a dead-letter queue. We'll also talk
                            about messages that take too long to process, what happens when the system is overloaded, and even discuss some weird failure
                            cases you might not expect. 👻🧟
                        </div>
                        <div>
                            For this workshop, we will be using <a href="https://www.pollydocs.org/" target="_blank">Polly</a> to build resilience
                            into our application. Polly exposes functionality that is really useful for our purposes:
                        </div>
                        <div>
                            <ul>
                                <li><strong>Retry</strong>: Automatically retry failed operations</li>
                                <li><strong>Wait and Retry</strong>: Retry with delay/backoff</li>
                                <li><strong>Circuit Breaker</strong>: Stop calling a failing system temporarily</li>
                                <li><strong>Fallback</strong>: Provide a fallback when things fail</li>
                                <li><strong>Timeout</strong>: Fail operations that take too long</li>
                                <li><strong>Rate Limiting</strong>: Prevent overloading systems</li>
                            </ul>
                        </div>
                        <div>
                            By the end of this exercise your app will be much more resilient, and you'll have a better understanding of how to keep
                            things running smoothly - even when things go wrong.
                        </div>

                        <h3 class="breadcrumb" id="vs-step1">1. Transient Failures</h3>
                        <div>
                            Sometimes, failures are just bad luck. Maybe a brief network issue or a momentary hiccup in the service. Maybe the service is trying
                            to update the same database record as another process and a concurrency exception is thrown. Instead of giving up right away, a
                            simple retry strategy can help.
                        </div>
                        <div>
                            Quite often, simply retrying to do the operation you were doing is enough.
                        </div>
                        <div>
                            This can be achieved by putting the message processing loop inside a <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:#8f08c4;">try</span>...<span style="color:#8f08c4;">catch</span></pre>
                            E.g.
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:#066555;">//&nbsp;Try&nbsp;to&nbsp;process&nbsp;the&nbsp;message&nbsp;3&nbsp;times</span>
<span style="color:#8f08c4;">for</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">i</span>&nbsp;=&nbsp;0;&nbsp;<span style="color:#1f377f;">i</span>&nbsp;&lt;&nbsp;3;&nbsp;<span style="color:#1f377f;">i</span>++)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">try</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#74531f;">HandleMessage</span>(<span style="color:#1f377f;">message</span>);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;we&#39;ve&nbsp;processed&nbsp;the&nbsp;message&nbsp;successfully</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;and&nbsp;we&nbsp;can&nbsp;break&nbsp;out&nbsp;of&nbsp;the&nbsp;loop</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">break</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">catch</span>&nbsp;(<span style="color:#066555;">Exception</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Log&nbsp;exception,&nbsp;but&nbsp;don&#39;t&nbsp;rethrow</span>
&nbsp;&nbsp;&nbsp;&nbsp;}
}
</pre>
                        </div>
                        <div>
                            While the manual approach works, Polly provides a much cleaner and more configurable way to handle retries.\
                            Let's implement a simple retry policy with Polly. First, install the Polly NuGet package.
                        </div>
                        <div>
                            With the Nuget package installed, we can build a <strong>retry policy</strong> for processing our messages.
                        </div>
                        <div>
                            Extract your code that handles incoming messages and put it in a method called <code>HandleMessage</code>. From here, we can wrap the call
                            to this method within a Polly <strong>RetryPolicy</strong>:
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:#066555;">//&nbsp;Create&nbsp;a&nbsp;retry&nbsp;policy&nbsp;that&nbsp;will&nbsp;retry&nbsp;3&nbsp;times&nbsp;immediately</span>
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">retryPolicy</span>&nbsp;=&nbsp;<span style="color:#066555;">Policy</span>
&nbsp;&nbsp;&nbsp;&nbsp;.<span style="color:#74531f;">Handle</span>&lt;<span style="color:#066555;">Exception</span>&gt;()&nbsp;<span style="color:#066555;">//&nbsp;You&nbsp;can&nbsp;be&nbsp;more&nbsp;specific&nbsp;here,&nbsp;e.g.,&nbsp;Handle&lt;HttpRequestException&gt;()</span>
&nbsp;&nbsp;&nbsp;&nbsp;.<span style="color:#74531f;">Retry</span>(3,&nbsp;(<span style="color:#1f377f;">exception</span>,&nbsp;<span style="color:#1f377f;">retryCount</span>)&nbsp;=&gt;
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">$&quot;</span><span style="color:#a31515;">Retry&nbsp;</span>{<span style="color:#1f377f;">retryCount</span>}<span style="color:#a31515;">&nbsp;due&nbsp;to&nbsp;</span>{<span style="color:#1f377f;">exception</span>.Message}<span style="color:#a31515;">&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;});

<span style="color:#1f377f;">retryPolicy</span>.<span style="color:#74531f;">Execute</span>(()&nbsp;=&gt;&nbsp;<span style="color:#74531f;">HandleMessage</span>(<span style="color:#1f377f;">message</span>));
</pre>
                        </div>
                        <div>
                            This will attempt to process the message 3 times. If the message cannot be processed after 3 attempts, the exception will bubble up.
                        </div>
                        <div>
                            Change your message receiver to use a Polly retry policy that will attempt to process messages 3 times.
                        </div>
                        <div>
                            Test your policy by throwing an exception in your message handler.
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;<span style="color:#74531f;">HandleMessage</span>(<span style="color:#066555;">ToggleLEDs</span>&nbsp;<span style="color:#1f377f;">message</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Attempting&nbsp;to&nbsp;process&nbsp;the&nbsp;message...&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">Exception</span>(<span style="color:#a31515;">&quot;Simulated&nbsp;Failure&quot;</span>);
}
</pre>
                        </div>

                        <h3 class="breadcrumb" id="vs-step2">2. Temporary, but not exactly transient errors</h3>
                        <div>
                            Sometimes errors persist longer than just a moment. In these cases, immediate retries won't help, but waiting a little bit longer might be enough to work.
                            This can happen for example when a 3rd party service is offline for a bit, or if there are database deadlocks that need another process to release a lock.
                            If the problem is due to a temporary error, it is possible that waiting for a few seconds before retrying the message could be enough to get the message
                            to succeed. This is where Polly's <code>WaitAndRetry</code> policy comes in handy.
                        </div>
                        <div>
                            Rather than retrying immediately, we can configure Polly to wait between retries, potentially with an increasing delay (exponential backoff).
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:#066555;">//&nbsp;Create&nbsp;a&nbsp;policy&nbsp;that&nbsp;will&nbsp;wait&nbsp;between&nbsp;retries&nbsp;with&nbsp;exponential&nbsp;backoff</span>
<span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">waitAndRetryPolicy</span>&nbsp;=&nbsp;<span style="color:#066555;">Policy</span>
&nbsp;&nbsp;&nbsp;&nbsp;.<span style="color:#74531f;">Handle</span>&lt;<span style="color:#066555;">Exception</span>&gt;()
&nbsp;&nbsp;&nbsp;&nbsp;.<span style="color:#74531f;">WaitAndRetry</span>(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#1f377f;">retryCount</span>:&nbsp;3,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#1f377f;">sleepDurationProvider</span>:&nbsp;<span style="color:#1f377f;">retryAttempt</span>&nbsp;=&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">TimeSpan</span>.<span style="color:#74531f;">FromSeconds</span>(<span style="color:#066555;">Math</span>.<span style="color:#74531f;">Pow</span>(2,&nbsp;<span style="color:#1f377f;">retryAttempt</span>)),&nbsp;<span style="color:#066555;">//&nbsp;2,&nbsp;4,&nbsp;8&nbsp;seconds</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#1f377f;">onRetry</span>:&nbsp;(<span style="color:#1f377f;">exception</span>,&nbsp;<span style="color:#1f377f;">timeSpan</span>,&nbsp;<span style="color:#1f377f;">retryCount</span>,&nbsp;<span style="color:#1f377f;">context</span>)&nbsp;=&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">$&quot;</span><span style="color:#a31515;">Retry&nbsp;</span>{<span style="color:#1f377f;">retryCount</span>}<span style="color:#a31515;">&nbsp;after&nbsp;</span>{<span style="color:#1f377f;">timeSpan</span>.TotalSeconds}<span style="color:#a31515;">s&nbsp;due&nbsp;to&nbsp;</span>{<span style="color:#1f377f;">exception</span>.Message}<span style="color:#a31515;">&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;);

<span style="color:#1f377f;">waitAndRetryPolicy</span>.<span style="color:#74531f;">Execute</span>(()&nbsp;=&gt;&nbsp;<span style="color:#74531f;">HandleMessage</span>(<span style="color:#1f377f;">message</span>));
</pre>
                        </div>
                        <div>
                            This policy will:

                            <ol>
                                <li>Try to process the message</li>
                                <li>If it fails, wait 2 seconds before the first retry</li>
                                <li>If it fails again, wait 4 seconds before the second retry</li>
                                <li>If it fails again, wait 8 seconds before the third retry</li>
                                <li>If it still fails, the exception will bubble up</li>
                            </ol>

                            This approach is good for handling temporary resource unavailability, like when a database is under
                            heavy load or when a downstream service is temporarily unavailable.
                        </div>
                        <div>
                            Your task now is to combine the immediate and the delayed retries.
                        </div>
                        <div>
                            Change your code to retry the message immediately 3 times, and if that fails, then use the <span style="font-family:Cascadia Mono;font-size:13px;color:#74531f;">WaitAndRetry</span> policy.
                        </div>
                        <div>
                            Test your code with a handler that fails until 5 seconds has elapsed:
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">failUntil</span>&nbsp;=&nbsp;<span style="color:#066555;">DateTime</span>.UtcNow.<span style="color:#74531f;">AddSeconds</span>(5);
<span style="color:blue;">void</span>&nbsp;<span style="color:#74531f;">HandleMessage</span>(<span style="color:#066555;">ToggleLEDs</span>&nbsp;<span style="color:#1f377f;">message</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">$&quot;</span><span style="color:#a31515;">Time:&nbsp;</span>{<span style="color:#066555;">DateTime</span>.UtcNow:<span style="color:#a31515;">HH:mm:ss</span>}<span style="color:#a31515;">&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">if</span>&nbsp;(<span style="color:#066555;">DateTime</span>.UtcNow&nbsp;<span style="color:#74531f;">&lt;</span>&nbsp;<span style="color:#1f377f;">failUntil</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#066555;">Exception</span>(<span style="color:#a31515;">&quot;Still&nbsp;failing...&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">Console</span>.<span style="color:#74531f;">WriteLine</span>(<span style="color:#a31515;">&quot;Message&nbsp;handled&nbsp;successfully!&quot;</span>);
}
</pre>
                        </div>

                        <h3 class="breadcrumb" id="vs-step3">3. Poison messasges</h3>
                        <div>
                            Some messages simply cannot be processed no matter how many times you try or how long you wait. These are often called "poison messages."
                            They might contain invalid data, reference non-existent resources, require permissions your service doesn't have, or your code might have a bug that
                            results in an exception being thrown.
                        </div>
                        <div>
                            When you detect a poison message, the best approach is usually to:

                            <ul>
                                <li>Log detailed information about why the message couldn't be processed</li>
                                <li>Move the message to a dead-letter queue (DLQ) for later analysis</li>
                                <li>Notify an administrator or monitoring system</li>
                            </ul>
                        </div>
                        <div>
                            Azure Service Bus has built-in support for dead-letter queues. If you detect that a message should be forwarded to the Dead-Letter Queue (DLQ), the message
                            can be forwarded using the <span style="font-family:Cascadia Mono;font-size:13px;color:#74531f;">DeadLetterMessageAsync</span> method on the
                            <span style="font-family:Cascadia Mono;font-size:13px;color:#066555;">ProcessMessageEventArgs</span> object:
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">async</span>&nbsp;<span style="color:#066555;">Task</span>&nbsp;<span style="color:#74531f;">Processor_ProcessMessageAsync</span>(<span style="color:#066555;">ProcessMessageEventArgs</span>&nbsp;<span style="color:#1f377f;">arg</span>)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">try</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#74531f;">HandleToggleLEDs</span>(<span style="color:#1f377f;">arg</span>.Message.Body);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">catch</span>&nbsp;(<span style="color:#066555;">Exception</span>&nbsp;<span style="color:#1f377f;">ex</span>)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Processing&nbsp;failed,&nbsp;move&nbsp;the&nbsp;message&nbsp;to&nbsp;the&nbsp;dead-letter&nbsp;queue</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8f08c4;">await</span>&nbsp;<span style="color:#1f377f;">arg</span>.<span style="color:#74531f;">DeadLetterMessageAsync</span>(<span style="color:#1f377f;">arg</span>.Message,&nbsp;<span style="color:#1f377f;">ex</span>.Message,&nbsp;<span style="color:#1f377f;">ex</span>.StackTrace);
&nbsp;&nbsp;&nbsp;&nbsp;}
}
</pre>
                        </div>
                        <div>
                            But how do we implement this using Polly? To do this in Polly, we can use the
                            <span style="font-family:Cascadia Mono;font-size:13px;color:#74531f;">Fallback</span><span style="font-family:Cascadia Mono;font-size:13px;color:black;">()</span>
                            method.
                        </div>
                        <div>
                            <pre style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;"><span style="color:blue;">var</span>&nbsp;<span style="color:#1f377f;">dqlPolicy</span>&nbsp;=&nbsp;<span style="color:#066555;">Policy</span>.<span style="color:#74531f;">Handle</span>&lt;<span style="color:#066555;">Exception</span>&gt;()
&nbsp;&nbsp;&nbsp;&nbsp;.<span style="color:#74531f;">FallbackAsync</span>(<span style="color:blue;">async</span>&nbsp;(<span style="color:#1f377f;">cancellationToken</span>)&nbsp;=&gt;
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;All&nbsp;retry&nbsp;attempts&nbsp;have&nbsp;failed</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066555;">//&nbsp;Move&nbsp;the&nbsp;message&nbsp;to&nbsp;the&nbsp;DLQ</span>
&nbsp;&nbsp;&nbsp;&nbsp;});
                        </div>
                        <div>
                            Your exercise now is to include the Fallback DQL policy into your existing retry policy. The final behaviour should be:
                            <ol>
                                <li>Retry the message 3 times</li>
                                <li>If that fails, use a time-base delay for 3 attempts</li>
                                <li>If that still fails, move the message to the DQL</li>
                            </ol>
                        </div>

                        <h4>What did we learn?</h4>
                        <div>
                            In this exercise, you explored how transient failures can impact distributed systems - and how retry strategies can help
                            make your system more resilient. You saw:

                            <ul>
                                <li>How immediate retries can help overcome short network blips or timing issues.</li>
                                <li>How delayed retries with exponential backoff reduce pressure on failing services and increase chances of recovery.</li>
                                <li>How to deal with messages that will never be processed, no matter how many times we try</li>
                            </ul>
                        </div>
                    </div>

                    <div class="tab-pane" id="bonus-exercise-tab-content" rold="tabpanel" aria-labelledby="bonusexercise-tab" tabindex="2">
                        <h3>Bonus round!</h3>

                        <div>
                            Done already? Waiting for everyone else to finish? Why not tackle some of these bonus challenges?
                        </div>

                        <h3 class="breadcrumb">1. Can you have different retry policies based on message payload?</h3>
                        <div>
                            See if you can have your messages exhibit different retry policies depending on what the
                            <span style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;">ToggleSource</span> of the message is.
                        </div>
                        <div>
                            If the <span style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;">ToggleSource</span> is the Button, have the retry
                            policy only include immediate retries.
                        </div>
                        <div>
                            But if the <span style="font-family:Cascadia Mono;font-size:13px;color:black;background:white;">ToggleSource</span> is from the console application,
                            then include the delayed retries as well as moving messages to the dead-letter queue.
                        </div>

                        <h3 class="breadcrumb">2. What happens to other messages in the queue while retries are processing?</h3>
                        <div>
                            What if the retry pipeline takes over a minute to process? Are the other messages sitting in the queue for that long?
                        </div>
                        <div>
                            What about if your application restarts while it's waiting for the delay to elapse?
                        </div>
                    </div>
                    <div class="footer-nav">
                        <a href="exercise5.html">&lt; Go to Exercise 5</a><a href="exercise7.html">Go to Exercise 7 &gt;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>