<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Escape room fun!</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Exercises</a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="exercise1.html">Exercise 1 - Intro to NanoFramework</a></li>
                                    <li><a class="dropdown-item" href="exercise2.html">Exercise 2 - Turning devices on/off</a></li>
                                    <li><a class="dropdown-item active" href="exercise3.html">Exercise 3 - Responding to HTTP requests</a></li>
                                    <li><a class="dropdown-item" href="exercise4.html">Exercise 4 - Intro to Azure Service Bus</a></li>
                                    <li><a class="dropdown-item" href="exercise5.html">Exercise 5 - Pub/Sub</a></li>
                                    <li><a class="dropdown-item" href="exercise6.html">Exercise 6 - Dealing with failures</a></li>
                                    <li><a class="dropdown-item" href="exercise7.html">Exercise 7 - Building an efficient pipeline</a></li>
                                    <li><a class="dropdown-item" href="exercise8.html">Exercise 8 - Message Timeouts</a></li>
                                    <li><a class="dropdown-item" href="exercise9.html">Exercise 9 - Rate Limiting</a></li>
                                    <li><a class="dropdown-item" href="exercise10.html">Exercise 10 - Delayed Delivery</a></li>
                                    <li><a class="dropdown-item" href="exercise11.html">Exercise 11 - Further patterns to learn</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/">Code Repo</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://github.com/WilliamBZA/1DayDistributedSystemsThroughPlay/tree/main/exercises/solutions">Solutions</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <div class="container heading">
            <div>
                <h1>Exercise 3:</h1>
                <h4>Turn lights on and off remotely</h4>
            </div>
        </div>
        
        <div class="container exercisedetails">
            <div class="col-lg-12">
                <ul class="nav nav-tabs" id="exercise-headings" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="gpio-tab" type="button" data-bs-toggle="tab" data-bs-target="#gpio-tab-content" role="tab" aria-controls="visualstudio-tab-content" aria-selected="false">
                            Remote calls
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bonusexercise-tab" type="button" data-bs-toggle="tab" data-bs-target="#bonus-exercise-tab-content" role="tab" aria-controls="bonus-exercise-tab-content" aria-selected="true">
                            Bonus exercises
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="exerciseContent">
                    <div class="tab-pane show active" id="gpio-tab-content" role="tabpanel" aria-labelledby="gpio-tab" tabindex="0">
                        <h3>Responding to an HTTP request</h3>

                        <div>
                            We're now going to start making remote calls to our devices. For your convenience, there is a button 👇 which makes an HTTP Post to
                            <code>/api/toggleleds/</code>. Your job is to add a handler to listen to requests.
                        </div>

                        <div class="d-flex justify-content-center">
                            <form action="/api/toggleleds">
                                <button class="btn btn-info btn-lg" type="submit">
                                    Click to Toggle LEDs
                                </button>
                            </form>
                        </div>

                        <h3 class="breadcrumb" id="vs-step1">1. Add a LedController.cs file</h3>
                        <div>
                            The solution contains a folder named <code>Controllers</code> which contains a class called <code>FileController.cs</code>. This class
                            is responsible for exposing HTTP methods that deal with updating files on the Sd card. We can use this as an example of how to add custom
                            controllers to respond to other HTTP requests.
                        </div>
                        <div>
                            Add a new class to the <code>Controllers</code> folder called <code>LedController.cs</code>. This class will be where we add the code to
                            toggle the LEDs in response to an HTTP call.
                        </div>

                        <div>
                            We need to tell the WebServer about the existence of this class. To wire this up, look at <code>Program.cs</code> inside the <code>main</code>
                            method towards the end, where the <code>WebServer</code> is instantiated and configured.
                        </div>
                        <div>
                            Note the array of Types being passed to the constructor of the <code>WebServer</code>:
                        </div>
                        <div>
                            <code>using (WebServer server = new WebServer(80, HttpProtocol.Http, new Type[] { typeof(FileController) }))</code>
                        </div>
                        <div>
                            Add the newly created <code>LedController</code> type to this array too. Once this is done, the WebServer will look for HTTP routes to listen to.
                        </div>

                        <h3 class="breadcrumb" id="vs-step2">2. Add a method bound to an HTTP Route</h3>
                        <div>
                            Add the following code to the <code>LedController</code> class:

                            <pre>[Method("POST")]
[Route("/api/toggleleds")]
public void ToggleLeds()
{

}</pre>
                        </div>

                        <div>
                            This method will now be invoked when our microcontroller receives an HTTP POST to <code>/api/toggleleds</code>
                        </div>

                        <h3 class="breadcrumb" id="vs-step3">3. Toggle the LEDs when an HTTP POST is made</h3>
                        <div>
                            All the pieces are in place now to toggle the LEDs based on an HTTP request.
                        </div>
                        <div>
                            Take a look at your code from exercise 2 and put that code into the <code>ToggleLeds</code> method.
                        </div>
                        <div>
                            If done correctly, your LEDs should toggle when you click the button on this page.
                        </div>
                    </div>

                    <div class="tab-pane" id="bonus-exercise-tab-content" rold="tabpanel" aria-labelledby="bonusexercise-tab" tabindex="2">
                        <h3>Bonus round!</h3>

                        <div>
                            Done already? Waiting for everyone else to finish? Why not tackle some of these bonus challenges?
                        </div>

                        <h3 class="breadcrumb">1. Trigger a LED toggle on someone else's device</h3>
                        <div>
                            Pair up with someone who has completed their exercises too. Find the IP Address of their device. See if you can make your <code>LedController</code>'s
                            <code>ToggleLeds</code> method make an HTTP POST Request to your partner's device.
                        </div>
                        <div>
                            You will have to create an instance of an <code>HttpWebRequest</code> to make a remote HTTP call. There is a sample showing how to do That
                            <a href="https://github.com/nanoframework/Samples/blob/main/samples/HTTP/HttpWebRequest/Program.cs#L78">here</a>.
                        </div>

                        <h3 class="breadcrumb">2. Trigger the remote device every second</h3>
                        <div>
                            Now that you're able to toggle the LEDs on a remote device, see if you can create a thread that will toggle the LEDs on the remote device
                            every second.
                        </div>
                        <div>
                            Take note of how many times the request fails.
                        </div>
                    </div>
                    <div class="footer-nav">
                        <a href="exercise2.html">&lt; Go to Exercise 2</a><a href="exercise4.html">Go to Exercise 4 &gt;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html>